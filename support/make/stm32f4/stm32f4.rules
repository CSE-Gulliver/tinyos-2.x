#-*-Makefile-*- vim:syntax=make
#$Id: pxa27x.rules,v 1.11 2008/06/12 23:25:01 kusy Exp $

define STM32_HELP

 STM32 extras:

   debug    : compile with minimal optimization and debug symbols
   debugopt : compile with debug symbols

 Programmer extras:

   openocd  : Use openocd to install

endef
HELP += $(STM_HELP)

GAS = arm-none-eabi-gcc -c # This ensures .c and .s compiled object are compatible
OBJCOPY = arm-none-eabi-objcopy 
OBJDUMP = arm-none-eabi-objdump
SET_ID = tos-set-symbols
XDB_SYMBOL_EXTRACT = dwarf2bd
NCC = ncc 
#LIBS = -lm -lvectors-stm32 -lstm32fw
LIBS = -lstm32f4fw
AR = arm-none-eabi-ar
ARFLAGS = cr


AMADDR = ActiveMessageAddressC\$$addr
BUILDDIR ?= build/$(PLATFORM)
MAIN_EXE = $(BUILDDIR)/main.exe
MAIN_BIN = $(BUILDDIR)/main.bin
INSTALL_BIN = $(MAIN_BIN)$(if $(NODEID),-$(NODEID),)
#PLATFORM_DIR = $(TOSDIR)/platforms/stm32-p103
PLATFORM_DIR = $(TOSDIR)/platforms/stm32f4
#CHIP_DIR = $(TOSDIR)/chips/stm32
CHIP_DIR = $(TOSDIR)/chips/stm32f4
#LIBRARY_DIRS = -L$(PLATFORM_DIR)/vectors -L$(PLATFORM_DIR) -L$(CHIP_DIR)/fwlib
LIBRARY_DIRS =   -L$(CHIP_DIR)/fwlib 
INCLUDE_DIRS = -I$(CHIP_DIR) -I$(PLATFORM_DIR) -I$(CHIP_DIR)/fwlib -I$(CHIP_DIR)/fwlib/inc -I$(CHIP_DIR)/fwlib/inc/core -I$(CHIP_DIR)/fwlib/inc/peripherals/
#ASSEMBLY_FILES += $(PLATFORM_DIR)/mmu_table.s $(PLATFORM_DIR)/util.s 
ASSEMBLY_OBJS =  $(BUILDDIR)/asms.o
#LIBRARY_OBJS  =  $(PLATFORM_DIR)/vectors/stm32-vector.o


CFLAGS  = -std=gnu99 -g -O2 -Wall -Tstm32_flash.ld
CFLAGS += -mlittle-endian -mthumb -mthumb-interwork  -mcpu=cortex-m4

ifeq ($(FLOAT_TYPE), hard)
CFLAGS += -fsingle-precision-constant -Wdouble-promotion
CFLAGS += -mfpu=fpv4-sp-d16 -mfloat-abi=hard
#CFLAGS += -mfpu=fpv4-sp-d16 -mfloat-abi=softfp
else
CFLAGS += -msoft-float
endif


OPTFLAGS ?= -O3 -g
PFLAGS += -Wall -Wshadow $(NESC_FLAGS)
PFLAGS += -target=$(PLATFORM) -fnesc-cfile=$(BUILDDIR)/app.c -board=$(SENSORBOARD)
PFLAGS += $(LIBRARY_DIRS)
ifdef MSG_SIZE
PFLAGS += -DTOSH_DATA_LENGTH=$(MSG_SIZE)
endif
ifdef DEFAULT_LOCAL_GROUP
PFLAGS += -DDEFINED_TOS_AM_GROUP=$(DEFAULT_LOCAL_GROUP)
endif

LDFLAGS += $(INCLUDE_DIRS) $(LIBRARY_DIRS) 

DEFAULT_PROGRAM ?= install


BUILDLESS_DEPS += bytes

# Use the 'if' function instead of the 'ifdef' construct because ifdef freaks
# out with call in there.  I don't know why.
$(if $(PROGRAM),,$(call TOSMake_include,stm32f4/$(DEFAULT_PROGRAM).extra))

# Build storage file if volumes.xml present
ifneq ($(wildcard $(VOLUME_FILE)), )
build_storage: $(BUILDDIR)/StorageVolumes.h

exe0: build_storage

VOLUME_ALLOCATOR_FLAGS ?= 
$(BUILDDIR)/StorageVolumes.h: $(VOLUME_FILE)
	$(VOLUME_ALLOCATOR) $(VOLUME_ALLOCATOR_FLAGS) $(PLATFORMDIR) <$(VOLUME_FILE) >$@ || rm -f $@

PFLAGS += -I$(BUILDDIR)
else

build_storage: 

endif

ifndef BUILD_DEPS
  ifeq ($(filter $(BUILDLESS_DEPS),$(GOALS)),)
    BUILD_DEPS = bin bytes $(POST_BUILD_EXTRA_DEPS)
  endif
endif

setid: FORCE
	@cmd () { echo "$$@"; $$@; }; if [ x = x$(NODEID) ]; then cmd $(OBJCOPY) --output-target=binary $(MAIN_EXE) $(INSTALL_BIN); else cmd $(SET_ID) --objcopy $(OBJCOPY) --objdump $(OBJDUMP) --target binary $(MAIN_EXE) $(INSTALL_BIN) TOS_NODE_ID=$(NODEID) $(AMADDR)=$(NODEID); fi


bin: exe FORCE
	@cmd () { echo "$$@"; $$@; }; if [ "${PROGRAM}" = "xflash" ]; then $(XDB_SYMBOL_EXTRACT) $(MAIN_EXE); fi

exe: exe0 bytes FORCE
	@:

#exe0: builddir asms $(BUILD_EXTRA_DEPS) FORCE
exe0: builddir asms library $(BUILD_EXTRA_DEPS) FORCE
	@echo "    compiling $(COMPONENT) to a $(PLATFORM) binary"
	$(NCC) -o $(MAIN_EXE) $(OPTFLAGS) $(PFLAGS) $(CFLAGS) $(WIRING_CHECK_FLAGS) $(COMPONENT).nc $(LIBS) $(LDFLAGS) $(ASSEMBLY_OBJS)
ifdef WIRING_CHECK_FILE
	@nescc-wiring $(WIRING_CHECK_FILE)
endif
	@echo "    compiled $(COMPONENT) to $(MAIN_EXE)"

builddir: FORCE
	mkdir -p $(BUILDDIR)

bytes: FORCE
	@$(OBJDUMP) -h $(MAIN_EXE) | perl -ne '$$b{$$1}=hex $$2 if /^\s*\d+\s*\.(text|data|bss)\s+(\S+)/; END { printf("%16d bytes in ROM\n%16d bytes in RAM\n",$$b{text}+$$b{data},$$b{data}+$$b{bss}); }'

asms: 
	$(GAS) $(ASSEMBLY_FILES) -o $(BUILDDIR)/asms.o 

library:
	#cd $(PLATFORM_DIR)/vectors; make;
	cd $(CHIP_DIR)/fwlib; make;
	
clean:
	cd $(CHIP_DIR)/fwlib; make clean;